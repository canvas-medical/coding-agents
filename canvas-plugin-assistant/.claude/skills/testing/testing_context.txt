# Canvas Plugin Testing Guide

This document provides testing patterns for Canvas plugins.

## Test Setup

### Directory Structure

```
plugin_name/
├── plugin_name/
│   ├── protocols/
│   │   └── handler.py
│   └── CANVAS_MANIFEST.json
├── tests/
│   ├── __init__.py
│   ├── conftest.py          # Shared fixtures
│   ├── test_handler.py
│   └── test_api.py
├── pyproject.toml
└── README.md
```

### pyproject.toml Test Configuration

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_functions = ["test_*"]
addopts = "-v"

[tool.coverage.run]
source = ["plugin_name"]
omit = ["*/tests/*", "*/__pycache__/*"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
]
```

---

## Mocking Patterns

### Mocking Event Context

```python
import pytest
from unittest.mock import MagicMock, patch

@pytest.fixture
def mock_event():
    """Create a mock event with patient context."""
    event = MagicMock()
    event.context = {
        "patient": {"id": "patient-123"},
        "user": {"id": "staff-456", "type": "Staff"}
    }
    return event

@pytest.fixture
def mock_vitals_event(mock_event):
    """Create a mock vitals event."""
    mock_event.target.instance.blood_pressure_systolic = 150
    mock_event.target.instance.blood_pressure_diastolic = 95
    mock_event.target.instance.heart_rate = 72
    return mock_event
```

---

### Mocking Data Models

```python
@pytest.fixture
def mock_patient():
    """Create a mock patient."""
    patient = MagicMock()
    patient.id = "patient-123"
    patient.first_name = "John"
    patient.last_name = "Doe"
    patient.date_of_birth = "1980-01-15"
    return patient

def test_handler_with_patient(mock_event, mock_patient):
    with patch("canvas_sdk.v1.data.patient.Patient.objects") as mock_objects:
        mock_objects.get.return_value = mock_patient

        # Test handler logic
        handler = MyProtocol()
        handler.event = mock_event
        effects = handler.compute()

        mock_objects.get.assert_called_once_with(id="patient-123")
```

---

### Mocking Secrets

```python
@pytest.fixture
def mock_secrets():
    """Create mock secrets."""
    return {
        "API_KEY": "test-api-key-12345",
        "WEBHOOK_SECRET": "test-webhook-secret"
    }

def test_webhook_auth(mock_secrets):
    handler = WebhookAPI()
    handler.secrets = mock_secrets

    # Test authentication
    credentials = MagicMock()
    credentials.key = "test-api-key-12345"

    assert handler.authenticate(credentials) is True
```

---

## Testing Protocol Handlers

### Basic Event Handler Test

```python
from plugin_name.protocols.handler import AlertProtocol

class TestAlertProtocol:
    def test_high_bp_creates_alert(self, mock_vitals_event):
        """Test that high blood pressure creates a banner alert."""
        handler = AlertProtocol()
        handler.event = mock_vitals_event

        effects = handler.compute()

        assert len(effects) == 1
        # Verify effect properties
        effect = effects[0]
        assert "AddBannerAlert" in str(type(effect))

    def test_normal_bp_no_alert(self, mock_event):
        """Test that normal blood pressure creates no alert."""
        mock_event.target.instance.blood_pressure_systolic = 120
        mock_event.target.instance.blood_pressure_diastolic = 80

        handler = AlertProtocol()
        handler.event = mock_event

        effects = handler.compute()

        assert len(effects) == 0

    def test_missing_bp_no_alert(self, mock_event):
        """Test graceful handling of missing vitals data."""
        mock_event.target.instance.blood_pressure_systolic = None
        mock_event.target.instance.blood_pressure_diastolic = None

        handler = AlertProtocol()
        handler.event = mock_event

        effects = handler.compute()

        assert len(effects) == 0

    def test_missing_patient_id(self, mock_vitals_event):
        """Test graceful handling of missing patient context."""
        mock_vitals_event.context = {}

        handler = AlertProtocol()
        handler.event = mock_vitals_event

        effects = handler.compute()

        assert len(effects) == 0
```

---

## Testing API Handlers

### Authentication Tests

```python
from plugin_name.api.routes import MyAPI

class TestMyAPIAuthentication:
    def test_valid_api_key_authenticates(self, mock_secrets):
        """Test that valid API key passes authentication."""
        handler = MyAPI()
        handler.secrets = mock_secrets

        credentials = MagicMock()
        credentials.key = "test-api-key-12345"

        assert handler.authenticate(credentials) is True

    def test_invalid_api_key_rejected(self, mock_secrets):
        """Test that invalid API key fails authentication."""
        handler = MyAPI()
        handler.secrets = mock_secrets

        credentials = MagicMock()
        credentials.key = "wrong-key"

        assert handler.authenticate(credentials) is False

    def test_missing_api_key_rejected(self, mock_secrets):
        """Test that missing API key fails authentication."""
        handler = MyAPI()
        handler.secrets = mock_secrets

        credentials = MagicMock()
        credentials.key = None

        assert handler.authenticate(credentials) is False

    def test_missing_secret_rejected(self):
        """Test that unconfigured secret fails authentication."""
        handler = MyAPI()
        handler.secrets = {}

        credentials = MagicMock()
        credentials.key = "any-key"

        assert handler.authenticate(credentials) is False
```

### Session Credential Tests

```python
class TestSessionAuthentication:
    def test_staff_user_authenticated(self):
        """Test that staff users pass authentication."""
        handler = StaffOnlyAPI()

        credentials = MagicMock()
        credentials.logged_in_user = {"id": "staff-123", "type": "Staff"}

        assert handler.authenticate(credentials) is True

    def test_patient_user_rejected_for_staff_endpoint(self):
        """Test that patient users are rejected from staff-only endpoints."""
        handler = StaffOnlyAPI()

        credentials = MagicMock()
        credentials.logged_in_user = {"id": "patient-123", "type": "Patient"}

        assert handler.authenticate(credentials) is False

    def test_patient_accessing_own_data(self):
        """Test that patients can access their own data."""
        handler = PatientDataAPI()
        handler.request = MagicMock()
        handler.request.path_params = {"patient_id": "patient-123"}

        credentials = MagicMock()
        credentials.logged_in_user = {"id": "patient-123", "type": "Patient"}

        assert handler.authenticate(credentials) is True

    def test_patient_accessing_other_patient_data_rejected(self):
        """Test that patients cannot access other patients' data."""
        handler = PatientDataAPI()
        handler.request = MagicMock()
        handler.request.path_params = {"patient_id": "patient-456"}

        credentials = MagicMock()
        credentials.logged_in_user = {"id": "patient-123", "type": "Patient"}

        assert handler.authenticate(credentials) is False
```

---

## Coverage Checking

### Running Coverage

```bash
# Basic coverage report
uv run pytest --cov=plugin_name --cov-report=term-missing

# With HTML report
uv run pytest --cov=plugin_name --cov-report=html

# With specific coverage threshold
uv run pytest --cov=plugin_name --cov-fail-under=90
```

### Interpreting Coverage Report

```
Name                              Stmts   Miss  Cover   Missing
---------------------------------------------------------------
plugin_name/__init__.py               0      0   100%
plugin_name/protocols/handler.py     45      5    89%   34-38
plugin_name/api/routes.py            32      2    94%   67, 89
---------------------------------------------------------------
TOTAL                                77      7    91%
```

- **Stmts**: Total statements in file
- **Miss**: Statements not covered by tests
- **Cover**: Percentage of statements covered
- **Missing**: Line numbers not covered

---

## Coverage Improvement Strategies

### Identify Uncovered Code

1. Run coverage with `--cov-report=term-missing`
2. Look at "Missing" column for uncovered lines
3. Prioritize error handling paths and edge cases

### Common Uncovered Areas

1. **Error handling branches**
   - Test with invalid input
   - Test with missing data
   - Test exception scenarios

2. **Conditional logic**
   - Test both true and false branches
   - Test boundary conditions

3. **Edge cases**
   - Empty lists/dicts
   - None values
   - Maximum/minimum values

### Writing Tests for Uncovered Lines

```python
# If line 34-38 are uncovered and handle missing patient:
def test_missing_patient_context(self, mock_event):
    """Cover lines 34-38: missing patient handling."""
    mock_event.context = {}  # No patient in context

    handler = MyProtocol()
    handler.event = mock_event
    effects = handler.compute()

    assert len(effects) == 0
```

---

## Test Organization Best Practices

### Group Tests by Functionality

```python
class TestAlertTriggers:
    """Tests for alert triggering conditions."""

    def test_high_systolic_triggers_alert(self): ...
    def test_high_diastolic_triggers_alert(self): ...
    def test_both_high_triggers_alert(self): ...

class TestAlertContent:
    """Tests for alert content and formatting."""

    def test_alert_contains_bp_values(self): ...
    def test_alert_has_correct_intent(self): ...

class TestEdgeCases:
    """Tests for edge cases and error handling."""

    def test_missing_vitals(self): ...
    def test_missing_patient(self): ...
    def test_invalid_bp_values(self): ...
```

### Use Descriptive Test Names

```python
# Good: describes scenario and expected outcome
def test_blood_pressure_above_180_creates_hypertensive_crisis_alert(self): ...

# Bad: vague
def test_alert(self): ...
```

### Use Fixtures for Common Setup

```python
# conftest.py
@pytest.fixture
def high_bp_event():
    """Event with hypertensive crisis blood pressure."""
    event = MagicMock()
    event.context = {"patient": {"id": "test-patient"}}
    event.target.instance.blood_pressure_systolic = 190
    event.target.instance.blood_pressure_diastolic = 125
    return event

@pytest.fixture
def normal_bp_event():
    """Event with normal blood pressure."""
    event = MagicMock()
    event.context = {"patient": {"id": "test-patient"}}
    event.target.instance.blood_pressure_systolic = 120
    event.target.instance.blood_pressure_diastolic = 80
    return event
```

---

## Coverage Report Template

When reporting coverage results:

```markdown
## Test Coverage Report: {plugin_name}

**Overall Coverage:** {X}%
**Target:** 90%
**Status:** {PASS / NEEDS IMPROVEMENT}

### File Coverage

| File | Coverage | Missing Lines |
|------|----------|---------------|
| protocols/handler.py | 89% | 34-38 |
| api/routes.py | 94% | 67, 89 |

### Recommended Tests to Add

1. **handler.py:34-38** - Missing patient context handling
   - Add test for empty context dict

2. **routes.py:67** - Error response branch
   - Add test for invalid request body

3. **routes.py:89** - Exception handling
   - Add test that triggers exception
```
